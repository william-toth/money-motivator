name: Build and Publish Chrome Extension

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Package extension
        run: |
          cd dist
          zip -r ../extension.zip .
          cd ..

      - name: Upload to Chrome Web Store
        run: |
          # Get access token
          TOKEN_RESPONSE=$(curl -s -X POST https://oauth2.googleapis.com/token \
            -d "client_id=${{ secrets.CHROME_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.CHROME_CLIENT_SECRET }}" \
            -d "refresh_token=${{ secrets.CHROME_REFRESH_TOKEN }}" \
            -d "grant_type=refresh_token")
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          
          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "Failed to get access token"
            echo "$TOKEN_RESPONSE"
            exit 1
          fi
          
          echo "✓ Got access token"
          
          # Upload extension
          echo "Uploading extension..."
          UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "x-goog-api-version: 2" \
            -X PUT \
            -T extension.zip \
            "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}?projection=DRAFT")
          
          HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | sed '$d')
          
          echo "Upload response (HTTP $HTTP_CODE):"
          echo "$RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Upload failed"
            exit 1
          fi
          
          echo "✓ Upload successful"
          
          # Publish extension
          echo "Publishing extension..."
          PUBLISH_RESPONSE=$(curl -s \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "x-goog-api-version: 2" \
            -H "Content-Length: 0" \
            -X POST \
            "https://www.googleapis.com/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}/publish")
          
          echo "Publish response:"
          echo "$PUBLISH_RESPONSE"
          
          # Check for errors in publish response
          if echo "$PUBLISH_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "Publish failed"
            exit 1
          fi
          
          echo "✓ Published successfully"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: extension.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
